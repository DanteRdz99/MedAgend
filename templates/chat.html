{% extends 'layout.html' %}
{% block title %}Asistente Virtual - MedAgenda{% endblock %}

{% block head %}
<style>
    .chat-container {
        max-width: 800px; margin: 0 auto;
        border: 1px solid #ccc; border-radius: 8px;
        height: 60vh; overflow-y: auto; padding: 15px;
        background-color: #fcfcfc; display: flex; flex-direction: column;
    }
    .message {
        margin-bottom: 12px; padding: 10px 15px;
        border-radius: 18px; max-width: 85%;
        word-wrap: break-word; line-height: 1.4;
    }
    .user-message {
        background-color: #007bff; color: white;
        margin-left: auto; border-bottom-right-radius: 3px;
        align-self: flex-end;
    }
    .ai-response {
        background-color: #e9ecef; color: #333;
        margin-right: auto; border-bottom-left-radius: 3px;
        align-self: flex-start;
    }
    .ai-response pre, .ai-response code {
        background-color: #fff; padding: 5px; border-radius: 4px;
        white-space: pre-wrap;
    }
    .chat-form-container { max-width: 800px; margin: 0 auto; }
    
    /* Indicador de "Escribiendo..." */
    .typing-indicator {
        display: none; /* Se activa con JS */
        align-self: flex-start;
        padding: 10px 15px;
        border-radius: 18px;
        background-color: #e9ecef;
        color: #333;
        margin-bottom: 12px;
    }
    .typing-indicator span {
        display: inline-block;
        width: 8px; height: 8px;
        background-color: #999;
        border-radius: 50%;
        margin: 0 2px;
        animation: bounce 1.4s infinite both;
    }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1.0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
    <div>
        <h2>Asistente Virtual</h2>
        <p class="lead">Hola {{ g.user.nombre_completo }}. Estoy aquí para ayudarte.</p>
    </div>
    <button id="clearChatBtn" class="btn btn-outline-danger btn-sm">Limpiar Chat</button>
</div>

<div class="chat-container mb-3" id="chat-box">
    {% if not chat_history %}
    <div class="message ai-response">
        <p class="mb-0">Hola, soy MedAgenda. Puedes pedirme que busque médicos por especialidad, que agende una cita o que revise tus citas programadas.</p>
    </div>
    {% endif %}
    
    {% for message in chat_history %}
        <div class="message {{ 'user-message' if message.role == 'user' else 'ai-response' }}">
            <p class="mb-0">{{ message.content | safe }}</p>
        </div>
    {% endfor %}
    
    <div class="message typing-indicator" id="typing-indicator">
        <span></span>
        <span></span>
        <span></span>
    </div>
</div>

<div class="chat-form-container">
    <div class="card p-3 shadow-sm">
        <form id="chatForm" class="input-group">
            <input type="text" class="form-control" id="messageInput" placeholder="Escribe tu mensaje..." required autocomplete="off" autofocus>
            <button type="submit" class="btn btn-primary" id="sendButton">Enviar</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chatBox = document.getElementById('chat-box');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const typingIndicator = document.getElementById('typing-indicator');

        // Función para hacer scroll al fondo
        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Scroll al final al cargar la página
        scrollToBottom();

        // Manejar envío del formulario
        chatForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message === '') return;

            // 1. Añadir mensaje de usuario al UI
            addMessageToUI(message, 'user');
            messageInput.value = '';
            toggleLoading(true);

            // 2. Enviar mensaje a la API de Chat
            fetch("{{ url_for('chat.api_chat_message') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // 3. Añadir respuesta de la IA al UI
                addMessageToUI(data.response, 'ai');
            })
            .catch(error => {
                console.error('Error en fetch:', error);
                addMessageToUI('Lo siento, hubo un error de conexión con el servidor. Por favor, intenta de nuevo.', 'ai');
            })
            .finally(() => {
                // 4. Ocultar indicador de "escribiendo"
                toggleLoading(false);
            });
        });

        // Manejar botón de limpiar chat
        clearChatBtn.addEventListener('click', function () {
            fetch("{{ url_for('chat.api_chat_clear') }}", { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Limpiar el contenido del chat en el DOM
                    chatBox.innerHTML = '';
                    // Añadir el indicador de escribiendo (para que no quede vacío)
                    chatBox.appendChild(typingIndicator);
                    // Opcional: Añadir mensaje de bienvenida
                    addMessageToUI('Hola, soy MedAgenda. ¿En qué te ayudo?', 'ai');
                }
            })
            .catch(error => {
                console.error('Error al limpiar chat:', error);
            });
        });

        // Función para añadir un mensaje al contenedor del chat
        function addMessageToUI(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(role === 'user' ? 'user-message' : 'ai-response');
            
            // Convertir saltos de línea a <br>
            messageDiv.innerHTML = `<p class="mb-0">${content.replace(/\n/g, '<br>')}</p>`;
            
            // Insertar antes del indicador de "escribiendo"
            chatBox.insertBefore(messageDiv, typingIndicator);
            scrollToBottom();
        }

        // Función para mostrar/ocultar el indicador de "escribiendo" y deshabilitar el input
        function toggleLoading(isLoading) {
            if (isLoading) {
                typingIndicator.style.display = 'flex';
                sendButton.disabled = true;
                messageInput.disabled = true;
            } else {
                typingIndicator.style.display = 'none';
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
            scrollToBottom();
        }
    });
</script>
{% endblock %}