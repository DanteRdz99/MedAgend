{% extends 'layout.html' %}
{% block title %}Asistente Virtual - MedAgenda{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
    <div>
        <h2><i class="bi bi-chat-dots-fill"></i> Asistente Virtual</h2>
        <p class="lead text-muted">Hola {{ g.user.nombre_completo }}. Estoy aquí para ayudarte.</p>
    </div>
    <button id="clearChatBtn" class="btn btn-outline-danger btn-sm">
        <i class="bi bi-trash"></i> Limpiar Chat
    </button>
</div>

<div class="chat-container mb-3 shadow-sm" id="chat-box">
    
    {% if not chat_history %}
    <div class="message ai-response">
        <p class_mb-0">Hola, soy MedAgenda. Puedes pedirme que busque médicos por especialidad, que agende una cita o que revise tus citas programadas.</p>
    </div>
    {% endif %}
    
    {% for message in chat_history %}
        <div class="message {{ 'user-message' if message.role == 'user' else 'ai-response' }}">
            <p class="mb-0">{{ message.content | safe }}</p>
        </div>
    {% endfor %}
    
    <div class_message typing-indicator" id="typing-indicator">
        <span></span>
        <span></span>
        <span></span>
    </div>
</div>

<div class="chat-form-container" style="max-width: 800px; margin: 0 auto;">
    <div class="card p-3 shadow-sm">
        <form id="chatForm" class="input-group">
            <input type="text" class="form-control form-control-lg" id="messageInput" placeholder="Escribe tu mensaje..." required autocomplete="off" autofocus>
            <button type="submit" class="btn btn-primary btn-lg" id="sendButton">
                <i class="bi bi-send-fill"></i> Enviar
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chatBox = document.getElementById('chat-box');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const typingIndicator = document.getElementById('typing-indicator');

        // Función para hacer scroll al fondo
        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Scroll al final al cargar la página
        scrollToBottom();

        // Manejar envío del formulario
        chatForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message === '') return;

            // 1. Añadir mensaje de usuario al UI
            addMessageToUI(message, 'user');
            messageInput.value = '';
            toggleLoading(true);

            // 2. Enviar mensaje a la API de Chat
            fetch("{{ url_for('chat.api_chat_message') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // 3. Añadir respuesta de la IA al UI
                addMessageToUI(data.response, 'ai');
            })
            .catch(error => {
                console.error('Error en fetch:', error);
                addMessageToUI('Lo siento, hubo un error de conexión con el servidor. Por favor, intenta de nuevo.', 'ai');
            })
            .finally(() => {
                // 4. Ocultar indicador de "escribiendo"
                toggleLoading(false);
            });
        });

        // Manejar botón de limpiar chat
        clearChatBtn.addEventListener('click', function () {
            fetch("{{ url_for('chat.api_chat_clear') }}", { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Limpiar el contenido del chat en el DOM
                    chatBox.innerHTML = '';
                    // Añadir el indicador de escribiendo (para que no quede vacío)
                    chatBox.appendChild(typingIndicator);
                    // Opcional: Añadir mensaje de bienvenida
                    addMessageToUI('Hola, soy MedAgenda. ¿En qué te ayudo?', 'ai');
                }
            })
            .catch(error => {
                console.error('Error al limpiar chat:', error);
            });
        });

        // Función para añadir un mensaje al contenedor del chat
        function addMessageToUI(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(role === 'user' ? 'user-message' : 'ai-response');
            
            // Convertir saltos de línea a <br>
            messageDiv.innerHTML = `<p class="mb-0">${content.replace(/\n/g, '<br>')}</p>`;
            
            // Insertar antes del indicador de "escribiendo"
            chatBox.insertBefore(messageDiv, typingIndicator);
            scrollToBottom();
        }

        // Función para mostrar/ocultar el indicador de "escribiendo" y deshabilitar el input
        function toggleLoading(isLoading) {
            if (isLoading) {
                typingIndicator.style.display = 'flex';
                sendButton.disabled = true;
                messageInput.disabled = true;
            } else {
                typingIndicator.style.display = 'none';
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
            scrollToBottom();
        }
    });
</script>
{% endblock %}